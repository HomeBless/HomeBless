{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Main Content -->
<div class="pt-[178px] pb-[60px]">
    {% include "components/search_bar.html" %}
    <!-- Main Content Area -->
    <div class="w-full h-auto inline-flex justify-start items-start gap-4">
        <div class="flex-1 self-stretch p-7 inline-flex flex-col justify-start items-start gap-4">
            <div class="inline-flex justify-start items-center gap-4">
                <div class="justify-start text-blue-700 text-3xl font-bold">
                    เปรียบเทียบในระแวกนี้
                </div>
                <div>
                    <label>
                        <select class="py-2 bg-stone-50 rounded-lg border border-slate-300 flex items-center gap-4">
                            <option value="5">5 ก.ม</option>
                            <option value="10" selected>10 ก.ม</option>
                            <option value="15">15 ก.ม</option>
                        </select>
                    </label>
                </div>
                <div>
                    <label>
                        <select class="py-2 bg-stone-50 rounded-lg border border-slate-300 flex items-center gap-4">
                            <option value="sell" selected>ขาย</option>
                            <option value="rent">เช่า</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="self-stretch flex flex-col justify-start items-start gap-8">
                <!-- First Row of Properties -->
                <div class="self-stretch inline-flex justify-start items-center gap-4">
                    {% include "components/compare/cheapest.html" %}
                    {% include "components/compare/most_expensive.html" %}
                </div>

                <!-- Second Row of Properties -->
                <div class="self-stretch inline-flex justify-start items-center gap-4">
                    {% include "components/compare/similar.html" %}
                    <!-- Wishlist Selection Box -->
                    <div id="wishlistBox" class="flex-1 self-stretch p-2.5 rounded-[10px] border-2 border-dashed border-slate-300 hover:bg-slate-100 hover:border-blue-500 inline-flex flex-col justify-center items-center gap-2.5 cursor-pointer">
                        <div class="self-stretch flex flex-col justify-start items-center">
                            <img src="{% static "bookmark.svg" %}" alt="Bookmark" class="w-7 h-7">
                            <div class="self-stretch p-2.5 inline-flex justify-center items-center gap-2.5">
                                <div class="justify-start text-gray-600 text-base font-normal">เลือกบ้านในบุ๊คมาร์กของคุณมาเปรียบเทียบ</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Main Comparison Panel -->
        <div class="w-[494px] self-stretch px-4 py-7 border-l border-slate-300 inline-flex flex-col justify-start items-center gap-4">
            <div class="self-stretch text-center justify-start text-blue-700 text-3xl font-bold">ตัวเปรียบเทียบหลัก</div>
            <div class="self-stretch flex flex-col justify-start items-start gap-2">
                <div class="self-stretch p-5 rounded-[10px] outline outline-1 outline-offset-[-1px] outline-slate-300 flex flex-col justify-start items-start gap-6">

                    <div class="flex items-start gap-2">
                        <!-- Main Image -->
                        <div class="relative flex-shrink-0 w-2/3 h-full">
                            <img class="w-full h-full object-cover rounded-l-[10px]" src="https://placehold.co/261x222" />
                        </div>

                        <!-- Small Images -->
                        <div class="flex flex-col gap-2 w-full h-full">
                            <img class="w-full h-1/2 object-cover rounded-tr-[10px]" src="https://placehold.co/144x107" />
                            <img class="w-full h-1/2 object-cover rounded-br-[10px]" src="https://placehold.co/144x107" />
                        </div>
                    </div>

                    <div class="self-stretch flex flex-col justify-start items-start gap-4">
                        <div class="self-stretch flex flex-col justify-start items-start gap-4">
                            <div class="self-stretch inline-flex justify-between items-center">
                                <div class="h-12 text-slate-600 text-base font-bold underline overflow-hidden text-ellipsis line-clamp-3">
                                    {{ main_title }}
                                </div>
                            </div>
                            <div class="inline-flex justify-start items-center">
                                <div class="px-2.5 border-r border-gray-600 flex justify-start items-center gap-1.5">
                                    <img src="{% static 'property-detail/area.svg' %}"alt="Area" class="w-5 h-5">
                                    <div class="justify-start text-gray-600 text-xs font-normal">
                                        {{ main_area }} ตร.ว.
                                    </div>
                                </div>
                                <div class="px-2.5 flex justify-start items-center gap-1.5">
                                    <img src="{% static 'property-detail/floor.svg' %}" alt="Floor" class="w-5 h-5">
                                    <div class="justify-start text-gray-600 text-xs font-normal">
                                        {{ main_floor }} ชั้น
                                    </div>
                                </div>
                                <div class="px-2.5 border-l border-r border-gray-600 flex justify-start items-center gap-1.5">
                                    <img src="{% static 'property-detail/bedroom.svg' %}" alt="Bed" class="w-5 h-5">
                                    <div class="justify-start text-gray-600 text-xs font-normal">
                                        {{ main_bedroom }} ห้องนอน
                                    </div>
                                </div>
                                <div class="px-2.5 flex justify-start items-center gap-1.5">
                                    <img src="{% static 'property-detail/bathroom.svg' %}" alt="Bath" class="w-5 h-5">
                                    <div class="justify-start text-gray-600 text-xs font-normal">
                                        {{ main_bathroom }} ห้องน้ำ
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="self-stretch inline-flex justify-start items-center gap-2">
                            <div class="flex-1 justify-start text-[#2DAB6F] text-3xl font-bold">
                              {{ main_price }}
                            </div>
                            <div class="justify-start text-[#2DAB6F] text-3xl font-bold">บาท</div>
                        </div>
                    </div>
                </div>
                <div class="self-stretch pl-5 py-2.5 border-b border-slate-300 flex flex-col justify-start items-start">
                    <div class="self-stretch justify-start text-gray-600 text-base font-bold">ราคาต่อตารางวา</div>
                    <div class="self-stretch justify-start text-gray-600 text-base font-normal">
                        <span>{{ main_price_per_wa }}</span>
                        <span>บาท/ตารางวา</span>
                    </div>
                </div>
                <div class="self-stretch pl-5 py-2.5 border-b border-slate-300 flex flex-col justify-start items-start">
                    <div class="self-stretch justify-start text-gray-600 text-base font-bold">ประเภท</div>
                    <div class="self-stretch justify-start text-gray-600 text-base font-normal">
                        {{ main_type }}
                    </div>
                </div>
            </div>
            <a href="{% url 'HomeBless:property-detail' main_id %}" class="w-full">
            <button class="w-full p-2.5 bg-blue-700 rounded-md inline-flex justify-center items-center gap-2 hover:bg-blue-800 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <div class="justify-start text-stone-50 text-base font-normal">กลับไปที่หน้าหลักของบ้านนี้</div>
            </button>
            </a>
        </div>
    </div>
</div>

{% include "components/wishlist_overlay.html" %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const wishlistBox = document.getElementById('wishlistBox');
    const overlay = document.getElementById('wishlist-overlay');
    const closeBtn = document.getElementById('close-overlay');
    const cancelBtn = document.getElementById('cancel-selection');
    const confirmBtn = document.getElementById('confirm-selection');
    const selectButtons = document.querySelectorAll('.select-property');

    let selectedPropertyId = null;

    if (wishlistBox) {
        wishlistBox.addEventListener('click', function(e) {
            e.preventDefault();
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            document.body.classList.add('overflow-hidden');
        });
    }

    function hideOverlay() {
        overlay.classList.remove('flex');
        overlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        selectedPropertyId = null;
        selectButtons.forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-blue-100', 'text-blue-600');
            btn.textContent = 'เลือก';
        });
        confirmBtn.disabled = true;
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('select-property') || e.target.closest('.select-property')) {
            const button = e.target.classList.contains('select-property') ?
                e.target : e.target.closest('.select-property');

            selectedPropertyId = button.getAttribute('data-property-id');

            document.querySelectorAll('.select-property').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-600');
                btn.textContent = 'เลือก';
            });

            button.classList.remove('bg-blue-100', 'text-blue-600');
            button.classList.add('bg-blue-600', 'text-white');
            button.textContent = 'เลือกแล้ว';
            confirmBtn.disabled = false;
        }
    });

    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (selectedPropertyId) {
                fetch('/compare/set-wishlist-property/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        property_id: selectedPropertyId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('การบันทึกล้มเหลว');
                    }
                })
                .catch(() => {
                    alert('เกิดข้อผิดพลาดระหว่างการส่งคำขอ');
                });
            }
            hideOverlay();
        });
    }

    if (closeBtn) closeBtn.addEventListener('click', hideOverlay);
    if (cancelBtn) cancelBtn.addEventListener('click', hideOverlay);
});
</script>

{% endblock %}
